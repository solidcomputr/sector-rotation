<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sector Rotation (Google Engine)</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --bg-color: #f4f4f9; --card-bg: #ffffff; --text-primary: #333; --text-secondary: #666;
            --border-color: #e0e0e0; --accent-blue: #007bff; --grid-color: #e0e0e0;
        }
        [data-theme="dark"] {
            --bg-color: #000000; --card-bg: #121212; --text-primary: #e0e0e0; --text-secondary: #a0a0a0;
            --border-color: #333; --accent-blue: #4dabf7; --grid-color: #333;
        }
        body { font-family: 'Segoe UI', Roboto, sans-serif; text-align: center; background-color: var(--bg-color); color: var(--text-primary); padding: 20px; transition: 0.3s; }
        h1 { margin-bottom: 20px; font-weight: 300; text-transform: uppercase; letter-spacing: 1px; }
        .header-row { max-width: 1100px; margin: 0 auto 20px auto; display: flex; justify-content: space-between; align-items: center; }
        .theme-switch-wrapper { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 0.9em; }
        .theme-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-blue); }
        input:checked + .slider:before { transform: translateX(24px); }
        
        #controls, #chart-card {
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 1100px; margin: 0 auto 25px auto; padding: 25px; transition: 0.3s;
        }
        #chart-container { width: 100%; height: 800px; }
        
        button { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; margin: 0 5px; }
        .select-btn { background: var(--accent-blue); color: white; }
        .clear-btn { background: #e0e0e0; color: #333; }
        
        #checkbox-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .sector-label { font-size: 0.85em; cursor: pointer; display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 4px; background: rgba(128,128,128,0.1); }
        .ticker-span { font-weight: 700; }
        
        input[type=range] { width: 100%; cursor: pointer; margin-top: 15px; accent-color: var(--accent-blue); }
        #date-display { font-size: 1.6em; font-weight: 600; display: block; margin-bottom: 5px; color: var(--text-primary); }
        .highlight { color: var(--accent-blue); }
    </style>
</head>
<body>
    <div class="header-row">
        <h1>Sector Rotation</h1>
        <div class="theme-switch-wrapper">
            <span>Dark Mode</span>
            <label class="theme-switch"><input type="checkbox" id="darkModeToggle" onclick="toggleTheme()"><span class="slider"></span></label>
        </div>
    </div>

    <div id="controls">
        <div style="margin-bottom: 20px;">
            <button class="select-btn" onclick="toggleAll(true)">Select All</button>
            <button class="clear-btn" onclick="toggleAll(false)">Clear All</button>
        </div>
        <div id="checkbox-container"></div>
        <span id="date-display">Loading Data...</span>
        <span id="sub-text">Fetching live data from Google Sheets...</span>
        <input type="range" id="stepSlider" min="0" max="6" value="6" step="1" disabled>
    </div>

    <div id="chart-card">
        <div id="chart-container"></div>
    </div>

    <script>
        // --- PASTE YOUR GOOGLE SHEETS CSV LINK HERE ---
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRKiSJvMjdh123iTfKji9agJYaogbiDcwxTh51LEZDImpAanb3cFfeyBT4Cf-izrtWBLuzvHPGhCPYf/pubhtml";
        
        const CUTOFF_TIMESTAMP = new Date("2025-12-23").getTime();

        // Map columns from the sheet to tickers (Order matches the HSTACK formula)
        // Col 0=Date, 1=Close(SPY), 2=XLK, 3=XLF, etc.
        const SECTOR_MAP = [
            { tick: 'XLK', name: 'Technology', colIndex: 2, color: '#1f77b4' },
            { tick: 'XLF', name: 'Financials', colIndex: 3, color: '#ff7f0e' },
            { tick: 'XLV', name: 'Healthcare', colIndex: 4, color: '#2ca02c' },
            { tick: 'XLC', name: 'Comm. Svcs', colIndex: 5, color: '#d62728' },
            { tick: 'XLY', name: 'Discretionary', colIndex: 6, color: '#9467bd' },
            { tick: 'XLI', name: 'Industrials', colIndex: 7, color: '#8c564b' },
            { tick: 'XLP', name: 'Staples', colIndex: 8, color: '#e377c2' },
            { tick: 'XLE', name: 'Energy', colIndex: 9, color: '#7f7f7f' },
            { tick: 'XLU', name: 'Utilities', colIndex: 10, color: '#bcbd22' },
            { tick: 'XLRE', name: 'Real Estate', colIndex: 11, color: '#17becf' },
            { tick: 'XLB', name: 'Materials', colIndex: 12, color: '#aec7e8' }
        ];

        let FINAL_DATA = {};
        let DATE_LABELS = [];
        let VISIBLE_SECTORS = new Set(SECTOR_MAP.map(s => s.tick)); 
        let IS_DARK_MODE = false;

        function toggleTheme() {
            IS_DARK_MODE = document.getElementById('darkModeToggle').checked;
            document.body.setAttribute('data-theme', IS_DARK_MODE ? 'dark' : 'light');
            if (Object.keys(FINAL_DATA).length > 0) updateChart();
        }

        function startApp() {
            setupCheckboxes();
            const status = document.getElementById('sub-text');
            
            if (SHEET_URL.includes("PASTE_YOUR")) {
                status.innerText = "Error: Please edit index.html and paste your Google CSV Link.";
                status.style.color = "red";
                return;
            }

            Papa.parse(SHEET_URL, {
                download: true,
                header: false, // We use index based parsing
                skipEmptyLines: true,
                complete: function(results) {
                    processSheetData(results.data);
                },
                error: function(err) {
                    status.innerText = "Error loading Google Sheet.";
                    console.error(err);
                }
            });
        }

        function processSheetData(rows) {
            // Rows[0] is headers, Rows[1...] is data
            // Col 0 is Date, Col 1 is SPY
            
            // Extract SPY and Dates first
            let spyPrices = [];
            let timestamps = [];
            
            // Start loop at 2 (Row 3 in sheet) to skip headers and potential loading rows
            for (let i = 2; i < rows.length; i++) {
                let row = rows[i];
                let dateStr = row[0]; // e.g., "2/4/2026 16:00:00"
                let spyVal = parseFloat(row[1]);

                if (!dateStr || isNaN(spyVal)) continue;
                
                let ts = new Date(dateStr).getTime();
                timestamps.push(ts);
                spyPrices.push(spyVal);
            }

            // Identify the 7 target indices (Weekly steps)
            let lastIndex = timestamps.length - 1;
            let targetIndices = [];
            for (let i = 0; i < 7; i++) {
                let idx = lastIndex - (i * 5); // 5 trading days = 1 week
                if (idx >= 0) targetIndices.unshift(idx);
            }

            DATE_LABELS = targetIndices.map(idx => {
                let d = new Date(timestamps[idx]);
                return d.toLocaleDateString("en-US", { day: 'numeric', month: 'short', year: 'numeric' });
            });

            // Process Each Sector
            SECTOR_MAP.forEach(item => {
                let col = item.colIndex;
                let points = [];
                let sectorPrices = rows.map(r => parseFloat(r[col])).slice(2); // Align with loop above
                
                // Note: slice(2) removed headers, but we pushed to arrays inside loop starting at 2
                // We need to access full columns to align with targetIndices
                // Let's grab the full column data cleanly:
                let fullSectorPrices = [];
                for(let k=2; k<rows.length; k++) fullSectorPrices.push(parseFloat(rows[k][col]));

                targetIndices.forEach((idx, step) => {
                    // Check Cutoff
                    if (timestamps[idx] < CUTOFF_TIMESTAMP) return;
                    if (idx < 60) return; // Need history for calc

                    let spyNow = spyPrices[idx];
                    let spyOld60 = spyPrices[idx-60];
                    let spyOld10 = spyPrices[idx-10];
                    
                    let secNow = fullSectorPrices[idx];
                    let secOld60 = fullSectorPrices[idx-60];
                    let secOld10 = fullSectorPrices[idx-10];

                    if(!spyNow || !secNow) return;

                    // RRG Math
                    let spyTrend = (spyNow - spyOld60) / spyOld60;
                    let secTrend = (secNow - secOld60) / secOld60;
                    let rsRatio = 100 + ((secTrend - spyTrend) * 100);

                    let spyMom = (spyNow - spyOld10) / spyOld10;
                    let secMom = (secNow - secOld10) / secOld10;
                    let rsMom = 100 + ((secMom - spyMom) * 100);

                    let x = 100 + (rsRatio - 100) * 6;
                    let y = 100 + (rsMom - 100) * 6;
                    
                    points.push({ x: x, y: y, date: DATE_LABELS[step] });
                });
                FINAL_DATA[item.tick] = points;
            });

            document.getElementById('sub-text').innerText = "Live Market Data Loaded.";
            setupSlider();
        }

        function setupSlider() {
            const slider = document.getElementById('stepSlider');
            let maxSteps = DATE_LABELS.length - 1;
            slider.max = maxSteps;
            slider.value = maxSteps;
            slider.disabled = false;
            updateChart();
            slider.addEventListener('input', updateChart);
        }

        function updateChart() {
            let stepIndex = parseInt(document.getElementById('stepSlider').value);
            let dateStr = DATE_LABELS[stepIndex] || "N/A";
            document.getElementById('date-display').innerHTML = `Snapshot Date: <span class="highlight">${dateStr}</span>`;

            let traces = [];

            SECTOR_MAP.forEach(item => {
                if (!VISIBLE_SECTORS.has(item.tick)) return;
                if (!FINAL_DATA[item.tick]) return;
                
                let visiblePoints = FINAL_DATA[item.tick].filter((_, i) => i <= stepIndex);
                if (visiblePoints.length === 0) return;

                let xVals = visiblePoints.map(p => p.x);
                let yVals = visiblePoints.map(p => p.y);
                let color = item.color;

                traces.push({
                    x: xVals, y: yVals,
                    mode: 'lines+markers+text',
                    name: item.tick,
                    line: { color: color, width: 3, shape: 'spline' },
                    marker: { 
                        // HERE IS THE CHANGE:
                        // If it's the last point (head), size is 14. Otherwise, size is 6.
                        size: xVals.map((_, i) => i === xVals.length - 1 ? 14 : 6),
                        color: color,
                        opacity: xVals.map((_, i) => i === xVals.length - 1 ? 1 : 0.6),
                        line: {color: IS_DARK_MODE ? '#121212' : '#fff', width: 1} 
                    },
                    text: xVals.map((_, i) => i === xVals.length - 1 ? item.tick : ''),
                    textposition: 'top center',
                    textfont: { family: 'Arial', weight: 'bold', size: 14, color: color },
                    hoverinfo: 'name+x+y'
                });
            });

            const cardBg = IS_DARK_MODE ? '#121212' : '#ffffff';
            const gridColor = IS_DARK_MODE ? '#333333' : '#e0e0e0';
            const textColor = IS_DARK_MODE ? '#a0a0a0' : '#666666';
            
            Plotly.react('chart-container', traces, {
                title: false, showlegend: false,
                paper_bgcolor: cardBg, plot_bgcolor: cardBg,
                font: { color: textColor },
                xaxis: { title: 'Relative Trend', range: [0, 250], zeroline: false, showgrid: true, gridcolor: gridColor },
                yaxis: { title: 'Relative Momentum', range: [0, 250], zeroline: false, showgrid: true, gridcolor: gridColor },
                margin: { l: 50, r: 40, b: 50, t: 30 },
                hovermode: 'closest',
                annotations: [
                    { x: 10, y: 240, text: 'Improving', showarrow: false, font: { size: 16, color: '#4dabf7', weight: 'bold' }, xanchor: 'left' },
                    { x: 240, y: 240, text: 'Leading', showarrow: false, font: { size: 16, color: '#2ca02c', weight: 'bold' }, xanchor: 'right' },
                    { x: 10, y: 10, text: 'Lagging', showarrow: false, font: { size: 16, color: '#d62728', weight: 'bold' }, xanchor: 'left' },
                    { x: 240, y: 10, text: 'Weakening', showarrow: false, font: { size: 16, color: '#ff7f0e', weight: 'bold' }, xanchor: 'right' }
                ],
                shapes: [
                    { type: 'line', x0: 100, y0: 0, x1: 100, y1: 250, line: { color: '#888', width: 2 } },
                    { type: 'line', x0: 0, y0: 100, x1: 250, y1: 100, line: { color: '#888', width: 2 } },
                    { type: 'rect', x0: 100, y0: 100, x1: 250, y1: 250, fillcolor: 'rgba(0, 200, 0, 0.03)', line: {width:0}},
                    { type: 'rect', x0: 0, y0: 0, x1: 100, y1: 100, fillcolor: 'rgba(200, 0, 0, 0.03)', line: {width:0}},
                    { type: 'rect', x0: 0, y0: 100, x1: 100, y1: 250, fillcolor: 'rgba(0, 0, 200, 0.03)', line: {width:0}},
                    { type: 'rect', x0: 100, y0: 0, x1: 250, y1: 100, fillcolor: 'rgba(255, 165, 0, 0.03)', line: {width:0}}
                ]
            });
        }

        function setupCheckboxes() {
            const container = document.getElementById('checkbox-container');
            container.innerHTML = ''; 
            SECTOR_MAP.forEach(item => {
                const label = document.createElement('label');
                label.className = 'sector-label';
                const cb = document.createElement('input');
                cb.type = 'checkbox'; cb.checked = true; cb.value = item.tick;
                cb.className = 'sector-cb';
                cb.onchange = (e) => {
                    e.target.checked ? VISIBLE_SECTORS.add(item.tick) : VISIBLE_SECTORS.delete(item.tick);
                    if (Object.keys(FINAL_DATA).length > 0) updateChart();
                };
                label.append(cb);
                const span = document.createElement('span'); span.className = 'ticker-span'; span.style.color = item.color; span.innerText = item.tick;
                label.append(span, document.createTextNode(` (${item.name})`));
                container.append(label);
            });
        }

        function toggleAll(selectAll) {
            VISIBLE_SECTORS.clear();
            document.querySelectorAll('.sector-cb').forEach(cb => {
                cb.checked = selectAll;
                if(selectAll) VISIBLE_SECTORS.add(cb.value);
            });
            if (Object.keys(FINAL_DATA).length > 0) updateChart();
        }

        startApp();
    </script>
</body>
</html>
