<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sector Rotation (Live Tail Control)</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --bg-color: #f4f4f9; --card-bg: #ffffff; --text-primary: #333; --text-secondary: #666;
            --border-color: #e0e0e0; --accent-blue: #007bff; --grid-color: #e0e0e0;
        }
        [data-theme="dark"] {
            --bg-color: #000000; --card-bg: #121212; --text-primary: #e0e0e0; --text-secondary: #a0a0a0;
            --border-color: #333; --accent-blue: #4dabf7; --grid-color: #333;
        }
        body { font-family: 'Segoe UI', Roboto, sans-serif; text-align: center; background-color: var(--bg-color); color: var(--text-primary); padding: 20px; transition: 0.3s; }
        
        #controls, #chart-card {
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 1100px; margin: 0 auto 25px auto; padding: 25px; transition: 0.3s;
        }
        #chart-container { width: 100%; height: 800px; }
        
        /* Debug Box */
        #debug-log { 
            font-family: monospace; font-size: 0.85em; color: #d63384; 
            background: rgba(0,0,0,0.05); padding: 10px; border-radius: 4px; 
            margin-top: 10px; white-space: pre-wrap; display: none;
        }

        button { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; margin: 0 5px; }
        .select-btn { background: var(--accent-blue); color: white; }
        .clear-btn { background: #e0e0e0; color: #333; }
        
        #checkbox-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .sector-label { font-size: 0.85em; cursor: pointer; display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 4px; background: rgba(128,128,128,0.1); }
        .ticker-span { font-weight: 700; }
        
        input[type=range] { width: 100%; cursor: pointer; margin-top: 15px; accent-color: var(--accent-blue); }
        
        #tail-display { font-size: 1.4em; font-weight: 600; display: block; margin-bottom: 5px; color: var(--text-primary); }
        #latest-date { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 15px; display: block; }
        .highlight { color: var(--accent-blue); }
        
        .header-row { max-width: 1100px; margin: 0 auto 20px auto; display: flex; justify-content: space-between; align-items: center; }
        .theme-switch-wrapper { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 0.9em; }
        .theme-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-blue); }
        input:checked + .slider:before { transform: translateX(24px); }
        
        .slider-labels { display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.8em; color: var(--text-secondary); }
    </style>
</head>
<body>

    <div class="header-row">
        <h1>Sector Rotation</h1>
        <div class="theme-switch-wrapper">
            <span>Dark Mode</span>
            <label class="theme-switch"><input type="checkbox" id="darkModeToggle" onclick="toggleTheme()"><span class="slider"></span></label>
        </div>
    </div>

    <div id="controls">
        <div style="margin-bottom: 20px;">
            <button class="select-btn" onclick="toggleAll(true)">Select All</button>
            <button class="clear-btn" onclick="toggleAll(false)">Clear All</button>
        </div>
        
        <div id="checkbox-container"></div>
        
        <span id="tail-display">Tail Length: 0 Weeks</span>
        <span id="latest-date">Latest Data: Loading...</span>
        
        <input type="range" id="tailSlider" min="0" max="15" value="0" step="1" disabled>
        <div class="slider-labels">
            <span>0 (Snapshot)</span>
            <span>15 Weeks History</span>
        </div>

        <div id="debug-log"></div>
    </div>

    <div id="chart-card">
        <div id="chart-container"></div>
    </div>

    <script>
        // --- PASTE YOUR GOOGLE CSV LINK HERE ---
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRKiSJvMjdh123iTfKji9agJYaogbiDcwxTh51LEZDImpAanb3cFfeyBT4Cf-izrtWBLuzvHPGhCPYf/pub?output=csv";
        
        const CUTOFF_TIMESTAMP = new Date("2024-01-01").getTime(); // Extended fallback

        const SECTOR_MAP = [
            { tick: 'XLK', name: 'Technology', colIndex: 2, color: '#1f77b4' },
            { tick: 'XLF', name: 'Financials', colIndex: 3, color: '#ff7f0e' },
            { tick: 'XLV', name: 'Healthcare', colIndex: 4, color: '#2ca02c' },
            { tick: 'XLC', name: 'Comm. Svcs', colIndex: 5, color: '#d62728' },
            { tick: 'XLY', name: 'Discretionary', colIndex: 6, color: '#9467bd' },
            { tick: 'XLI', name: 'Industrials', colIndex: 7, color: '#8c564b' },
            { tick: 'XLP', name: 'Staples', colIndex: 8, color: '#e377c2' },
            { tick: 'XLE', name: 'Energy', colIndex: 9, color: '#7f7f7f' },
            { tick: 'XLU', name: 'Utilities', colIndex: 10, color: '#bcbd22' },
            { tick: 'XLRE', name: 'Real Estate', colIndex: 11, color: '#17becf' },
            { tick: 'XLB', name: 'Materials', colIndex: 12, color: '#aec7e8' }
        ];

        let FINAL_DATA = {};
        let ALL_DATES = [];
        let VISIBLE_SECTORS = new Set(SECTOR_MAP.map(s => s.tick)); 
        let IS_DARK_MODE = false;

        function logError(msg) {
            const el = document.getElementById('debug-log');
            el.style.display = 'block';
            el.innerText += "⚠️ " + msg + "\n";
            console.error(msg);
        }

        function toggleTheme() {
            IS_DARK_MODE = document.getElementById('darkModeToggle').checked;
            document.body.setAttribute('data-theme', IS_DARK_MODE ? 'dark' : 'light');
            if (Object.keys(FINAL_DATA).length > 0) updateChart();
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            let d = new Date(dateStr);
            if (!isNaN(d.getTime())) return d.getTime();
            const parts = dateStr.split(/[\/\-\.]/);
            if (parts.length === 3) {
                let year = parseInt(parts[2].substring(0, 4));
                let month = parseInt(parts[1]) - 1; 
                let day = parseInt(parts[0]);
                let d2 = new Date(year, month, day);
                if (!isNaN(d2.getTime())) return d2.getTime();
            }
            return null;
        }

        function startApp() {
            setupCheckboxes();
            const status = document.getElementById('latest-date');
            
            if (SHEET_URL.includes("PASTE_YOUR")) {
                status.innerText = "Error: Paste Google Link in Code.";
                status.style.color = "red";
                return;
            }

            fetch(SHEET_URL)
                .then(res => { if (!res.ok) throw new Error("Network Error"); return res.text(); })
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: false, skipEmptyLines: true,
                        complete: function(results) { processSheetData(results.data); }
                    });
                })
                .catch(err => { status.innerText = "Error loading Sheet."; logError(err.message); });
        }

        function processSheetData(rows) {
            if (!rows || rows.length < 5) { logError("Empty Sheet"); return; }

            let spyPrices = [];
            let timestamps = [];

            // 1. Parse all rows
            for (let i = 2; i < rows.length; i++) {
                let row = rows[i];
                let ts = parseDate(row[0]);
                let spyVal = parseFloat(row[1]);
                if (!ts || isNaN(spyVal)) continue;
                timestamps.push(ts);
                spyPrices.push(spyVal);
            }

            if (timestamps.length < 65) { logError("Insufficient History (Need > 65 days)."); return; }

            // 2. Identify Target Indices (Today + 15 weeks back = 16 points)
            // We want index 0 to be the OLDEST, index 15 to be NEWEST (Today)
            let lastIndex = timestamps.length - 1;
            let targetIndices = [];
            
            // Loop 15 down to 0
            for (let i = 15; i >= 0; i--) {
                let idx = lastIndex - (i * 5); // 5 days per week
                if (idx >= 60) { // Ensure we have 60 days buffer before this point
                    targetIndices.push(idx);
                }
            }

            ALL_DATES = targetIndices.map(idx => {
                let d = new Date(timestamps[idx]);
                return d.toLocaleDateString("en-US", { day: 'numeric', month: 'short', year: 'numeric' });
            });
            
            // Update "Latest Date" text
            if (ALL_DATES.length > 0) {
                document.getElementById('latest-date').innerText = "Latest Data: " + ALL_DATES[ALL_DATES.length - 1];
            }

            // 3. Calculate RRG for these indices
            SECTOR_MAP.forEach(item => {
                let col = item.colIndex;
                let points = [];
                let fullSectorPrices = [];
                for(let k=2; k<rows.length; k++) {
                    let val = parseFloat(rows[k][col]);
                    fullSectorPrices.push(isNaN(val) ? null : val);
                }

                targetIndices.forEach((idx, step) => {
                    // Match the timestamp index to the price arrays (which started at row 2)
                    let spyNow = spyPrices[idx];
                    let spyOld60 = spyPrices[idx-60];
                    let spyOld10 = spyPrices[idx-10];
                    
                    let secNow = fullSectorPrices[idx];
                    let secOld60 = fullSectorPrices[idx-60];
                    let secOld10 = fullSectorPrices[idx-10];

                    if(!spyNow || !secNow || !spyOld60 || !secOld60) return;

                    let spyTrend = (spyNow - spyOld60) / spyOld60;
                    let secTrend = (secNow - secOld60) / secOld60;
                    let rsRatio = 100 + ((secTrend - spyTrend) * 100);

                    let spyMom = (spyNow - spyOld10) / spyOld10;
                    let secMom = (secNow - secOld10) / secOld10;
                    let rsMom = 100 + ((secMom - spyMom) * 100);

                    let x = 100 + (rsRatio - 100) * 6;
                    let y = 100 + (rsMom - 100) * 6;
                    
                    points.push({ x: x, y: y, date: ALL_DATES[step] });
                });
                FINAL_DATA[item.tick] = points;
            });

            setupSlider();
        }

        function setupSlider() {
            const slider = document.getElementById('tailSlider');
            slider.disabled = false;
            slider.value = 0; // Default: Only most recent
            updateChart();
            slider.addEventListener('input', updateChart);
        }

        function updateChart() {
            let tailLength = parseInt(document.getElementById('tailSlider').value);
            document.getElementById('tail-display').innerHTML = `Tail Length: <span class="highlight">${tailLength} Weeks</span>`;

            let traces = [];

            SECTOR_MAP.forEach(item => {
                if (!VISIBLE_SECTORS.has(item.tick)) return;
                if (!FINAL_DATA[item.tick]) return;
                
                let fullData = FINAL_DATA[item.tick];
                let totalPoints = fullData.length;
                
                // SLICING LOGIC:
                // We always want the HEAD (last point).
                // We want 'tailLength' points BEFORE the head.
                // Start Index = (Total - 1) - TailLength
                let startIndex = (totalPoints - 1) - tailLength;
                if (startIndex < 0) startIndex = 0;

                let visiblePoints = fullData.slice(startIndex, totalPoints);
                if (visiblePoints.length === 0) return;

                let xVals = visiblePoints.map(p => p.x);
                let yVals = visiblePoints.map(p => p.y);
                let color = item.color;

                traces.push({
                    x: xVals, y: yVals,
                    mode: 'lines+markers+text',
                    name: item.tick,
                    line: { color: color, width: 3, shape: 'spline' },
                    marker: { 
                        // Last point = 14 (Head), others = 6 (Tail)
                        size: xVals.map((_, i) => i === xVals.length - 1 ? 14 : 6),
                        color: color,
                        opacity: xVals.map((_, i) => i === xVals.length - 1 ? 1 : 0.6),
                        line: {color: IS_DARK_MODE ? '#121212' : '#fff', width: 1} 
                    },
                    text: xVals.map((_, i) => i === xVals.length - 1 ? item.tick : ''),
                    textposition: 'top center',
                    textfont: { family: 'Arial', weight: 'bold', size: 14, color: color },
                    hoverinfo: 'name+x+y'
                });
            });

            const cardBg = IS_DARK_MODE ? '#121212' : '#ffffff';
            const gridColor = IS_DARK_MODE ? '#333333' : '#e0e0e0';
            const textColor = IS_DARK_MODE ? '#a0a0a0' : '#666666';
            
            Plotly.react('chart-container', traces, {
                title: false, showlegend: false,
                paper_bgcolor: cardBg, plot_bgcolor: cardBg,
                font: { color: textColor },
                xaxis: { title: 'Relative Trend', range: [0, 250], zeroline: false, showgrid: true, gridcolor: gridColor },
                yaxis: { title: 'Relative Momentum', range: [0, 250], zeroline: false, showgrid: true, gridcolor: gridColor },
                margin: { l: 50, r: 40, b: 50, t: 30 },
                hovermode: 'closest',
                annotations: [
                    { x: 10, y: 240, text: 'Improving', showarrow: false, font: { size: 16, color: '#4dabf7', weight: 'bold' }, xanchor: 'left' },
                    { x: 240, y: 240, text: 'Leading', showarrow: false, font: { size: 16, color: '#2ca02c', weight: 'bold' }, xanchor: 'right' },
                    { x: 10, y: 10, text: 'Lagging', showarrow: false, font: { size: 16, color: '#d62728', weight: 'bold' }, xanchor: 'left' },
                    { x: 240, y: 10, text: 'Weakening', showarrow: false, font: { size: 16, color: '#ff7f0e', weight: 'bold' }, xanchor: 'right' }
                ],
                shapes: [
                    { type: 'line', x0: 100, y0: 0, x1: 100, y1: 250, line: { color: '#888', width: 2 } },
                    { type: 'line', x0: 0, y0: 100, x1: 250, y1: 100, line: { color: '#888', width: 2 } },
                    { type: 'rect', x0: 100, y0: 100, x1: 250, y1: 250, fillcolor: 'rgba(0, 200, 0, 0.03)', line: {width:0}},
                    { type: 'rect', x0: 0, y0: 0, x1: 100, y1: 100, fillcolor: 'rgba(200, 0, 0, 0.03)', line: {width:0}},
                    { type: 'rect', x0: 0, y0: 100, x1: 100, y1: 250, fillcolor: 'rgba(0, 0, 200, 0.03)', line: {width:0}},
                    { type: 'rect', x0: 100, y0: 0, x1: 250, y1: 100, fillcolor: 'rgba(255, 165, 0, 0.03)', line: {width:0}}
                ]
            });
        }

        function setupCheckboxes() {
            const container = document.getElementById('checkbox-container');
            container.innerHTML = ''; 
            SECTOR_MAP.forEach(item => {
                const label = document.createElement('label');
                label.className = 'sector-label';
                const cb = document.createElement('input');
                cb.type = 'checkbox'; cb.checked = true; cb.value = item.tick;
                cb.className = 'sector-cb';
                cb.onchange = (e) => {
                    e.target.checked ? VISIBLE_SECTORS.add(item.tick) : VISIBLE_SECTORS.delete(item.tick);
                    if (Object.keys(FINAL_DATA).length > 0) updateChart();
                };
                label.append(cb);
                const span = document.createElement('span'); span.className = 'ticker-span'; span.style.color = item.color; span.innerText = item.tick;
                label.append(span, document.createTextNode(` (${item.name})`));
                container.append(label);
            });
        }

        function toggleAll(selectAll) {
            VISIBLE_SECTORS.clear();
            document.querySelectorAll('.sector-cb').forEach(cb => {
                cb.checked = selectAll;
                if(selectAll) VISIBLE_SECTORS.add(cb.value);
            });
            if (Object.keys(FINAL_DATA).length > 0) updateChart();
        }

        startApp();
    </script>
</body>
</html>
